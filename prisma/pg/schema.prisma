generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id
  email     String   @unique
  name      String?
  isActive  Int      @default(1) @map("is_active")
  createdAt DateTime @map("created_at")
  updatedAt DateTime @map("updated_at")

  magicLinks          MagicLink[]
  sessions            Session[]
  items               Item[]
  userCounter         UserCounter?
  apiKeys             ApiKey[]
  emailChangeRequest  EmailChangeRequest?
  openclawDevices     OpenclawDevice[]
  agentContents       AgentContent[]
  formResponses       FormResponse[]

  @@map("users")
}

model MagicLink {
  id        String    @id
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  consumedAt DateTime? @map("consumed_at")
  createdAt DateTime @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("magic_links")
}

model Session {
  id        String   @id
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model Item {
  id          String   @id
  humanId     Int      @map("human_id")
  userId      String   @map("user_id")
  title       String
  description String
  urgency     String
  tag         String
  importance  String
  deadline    String?
  status      String
  createdAt   DateTime @map("created_at")
  updatedAt   DateTime @map("updated_at")
  openedAt    DateTime @map("opened_at")
  createdBy     String   @map("created_by")
  modifiedBy    String   @map("modified_by")
  hasAIChanges  Boolean  @default(false) @map("has_ai_changes")
  contentId     String?  @map("content_id")

  user          User           @relation(fields: [userId], references: [id])
  notes         Note[]
  content       AgentContent?  @relation(fields: [contentId], references: [id])
  formResponses FormResponse[]

  @@unique([userId, humanId])
  @@index([userId, status, urgency])
  @@index([userId, deadline])
  @@index([userId, updatedAt(sort: Desc)])
  @@index([userId, contentId])
  @@map("items")
}

model AgentContent {
  id          String   @id
  userId      String   @map("user_id")
  type        String
  title       String?
  body        String
  externalId  String?  @map("external_id")
  contentHash String   @map("content_hash")
  createdAt   DateTime @map("created_at")
  updatedAt   DateTime @map("updated_at")

  user         User           @relation(fields: [userId], references: [id])
  items        Item[]
  formResponses FormResponse[]

  @@unique([userId, externalId])
  @@index([userId, contentHash])
  @@map("agent_contents")
}

model FormResponse {
  id        String   @id
  userId    String   @map("user_id")
  contentId String   @map("content_id")
  itemId    String?  @map("item_id")
  response  String
  createdAt DateTime @map("created_at")

  user    User         @relation(fields: [userId], references: [id])
  content AgentContent @relation(fields: [contentId], references: [id])
  item    Item?        @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@index([contentId])
  @@map("form_responses")
}

model Note {
  id        String   @id
  itemId    String   @map("item_id")
  author    String
  content   String
  createdAt DateTime @map("created_at")
  updatedAt DateTime @map("updated_at")

  item Item @relation(fields: [itemId], references: [id])

  @@index([itemId, createdAt(sort: Desc)])
  @@map("notes")
}

model UserCounter {
  userId     String @id @map("user_id")
  nextHumanId Int   @map("next_human_id")

  user User @relation(fields: [userId], references: [id])

  @@map("user_counters")
}

model ApiKey {
  id        String   @id
  userId    String   @map("user_id")
  keyHash   String   @unique @map("key_hash")
  name      String?
  createdAt DateTime @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([keyHash])
  @@map("api_keys")
}

model EmailChangeRequest {
  id        String   @id
  userId    String   @unique @map("user_id")
  newEmail  String   @map("new_email")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("email_change_requests")
}

model OpenclawDevice {
  id         String   @id
  deviceCode String  @unique @map("device_code")
  displayCode String @unique @map("display_code")
  email      String
  userId     String?  @map("user_id")
  apiKeyId   String?  @map("api_key_id")
  apiToken   String?  @map("api_token")
  status     String
  expiresAt DateTime @map("expires_at")
  createdAt  DateTime @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([deviceCode])
  @@index([displayCode])
  @@index([expiresAt])
  @@map("openclaw_devices")
}
